<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Kathputli | A Digital Performance</title>
    
    <!-- GSAP for physics-based animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <style>
        :root {
            --stage-dark: #050202;
            --spotlight: #ffdbac;
            --string-color: rgba(255, 255, 255, 0.4);
            --gold: #FFD700;
            --crimson: #800000;
            --font-main: 'Courier New', Courier, monospace; 
            --font-serif: 'Georgia', serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--stage-dark);
            color: var(--spotlight);
            font-family: var(--font-main);
            overflow-x: hidden;
            /* Prevent bounce on mobile */
            overscroll-behavior-y: none;
        }

        /* --- STAGE AMBIANCE --- */
        .stage-lighting {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at 50% 40%, rgba(255, 160, 122, 0.08) 0%, rgba(5, 2, 2, 1) 85%);
            pointer-events: none;
            z-index: 1;
        }

        .grain-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 2;
        }

        /* --- THE PUPPET --- */
        #puppet-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Let clicks pass through to scroll */
            z-index: 50;
        }

        /* SVG Styles */
        .string {
            stroke: var(--string-color);
            stroke-width: 1;
            opacity: 0.6;
            filter: drop-shadow(0 0 1px rgba(255,255,255,0.2));
            transition: stroke 0.5s, stroke-width 0.5s;
        }

        /* --- SCROLL CONTENT (The Narrative) --- */
        .scroll-container {
            position: relative;
            z-index: 10;
        }

        section {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 2rem;
            box-sizing: border-box;
            opacity: 0; 
            transition: opacity 1.5s ease-out;
            pointer-events: none; /* Allow seeing through to puppet interaction */
        }

        section.visible {
            opacity: 1;
        }

        .text-block {
            pointer-events: auto;
            max-width: 550px;
            margin-left: 8%;
            background: rgba(10, 5, 5, 0.6);
            padding: clamp(1.5rem, 4vw, 3rem);
            border-left: 2px solid var(--gold);
            backdrop-filter: blur(4px);
            border-radius: 0 4px 4px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        h1 {
            font-size: clamp(1.8rem, 4vw, 3rem);
            margin: 0 0 1.5rem 0;
            line-height: 1.1;
            color: var(--gold);
            font-family: var(--font-serif);
            font-weight: normal;
        }

        h2 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: #d65a31;
            margin-bottom: 0.5rem;
            opacity: 0.8;
        }

        p {
            line-height: 1.9;
            font-size: clamp(1rem, 1.2vw, 1.2rem);
            color: #e0e0e0;
            margin-bottom: 1.5rem;
        }
        
        p:last-child {
            margin-bottom: 0;
        }

        .highlight {
            color: var(--gold);
            font-style: italic;
        }

        /* --- UI CONTROLS --- */
        .controls {
            position: fixed;
            bottom: max(30px, env(safe-area-inset-bottom));
            right: max(30px, env(safe-area-inset-right));
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
        }

        .btn {
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 10px 20px;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.75rem;
            transition: all 0.4s ease;
            pointer-events: auto;
            border-radius: 50px;
            backdrop-filter: blur(5px);
        }

        .btn:hover {
            background: var(--gold);
            color: var(--stage-dark);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .instruction {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.3);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            pointer-events: none;
            animation: pulse 3s infinite;
            text-align: center;
            width: 100%;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 768px) {
            .text-block {
                margin: 0 auto;
                width: 90%;
                margin-top: 45vh; /* Push text below puppet on mobile */
                background: linear-gradient(to top, rgba(5,2,2,0.95), rgba(5,2,2,0.7));
                border-left: none;
                border-top: 2px solid var(--gold);
                border-radius: 10px 10px 0 0;
                padding-bottom: 4rem;
            }
            
            section {
                padding: 1rem;
                justify-content: flex-start;
            }
            
            /* Tweak puppet position for mobile portrait */
            #puppet-container {
                top: -10%;
            }
        }
    </style>
</head>
<body>

    <!-- Ambient Layers -->
    <div class="stage-lighting"></div>
    <div class="grain-overlay"></div>

    <!-- The Puppet Stage -->
    <!-- ViewBox 0 0 1000 1000 allows for consistent coordinate system -->
    <svg id="puppet-container" viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid slice">
        <defs>
            <!-- Fabric Gradients -->
            <radialGradient id="skirtGradient" cx="50%" cy="20%" r="80%">
                <stop offset="0%" style="stop-color:#d92828;stop-opacity:1" />
                <stop offset="60%" style="stop-color:#8a0a0a;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#3d0202;stop-opacity:1" />
            </radialGradient>
            
            <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#b8860b;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#ffd700;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#b8860b;stop-opacity:1" />
            </linearGradient>

            <radialGradient id="faceGradient" cx="40%" cy="40%" r="50%">
                <stop offset="0%" style="stop-color:#ffcc99;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#d4a373;stop-opacity:1" />
            </radialGradient>

            <pattern id="motif" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                <circle cx="10" cy="10" r="2" fill="#ffd700" opacity="0.5"/>
            </pattern>
        </defs>

        <!-- Invisible Strings -->
        <line id="string-head" class="string" x1="500" y1="0" x2="500" y2="300" />
        <line id="string-l-hand" class="string" x1="400" y1="0" x2="450" y2="400" />
        <line id="string-r-hand" class="string" x1="600" y1="0" x2="550" y2="400" />

        <!-- The Puppet Group -->
        <g id="kathputli">
            <!-- Skirt (The Ghagra) -->
            <g id="skirt-group">
                <!-- Main volume -->
                <path id="skirt" class="puppet-part skirt" 
                      d="M 460 450 Q 500 440 540 450 L 620 750 Q 500 800 380 750 Z" 
                      fill="url(#skirtGradient)" stroke="#500" stroke-width="1"/>
                
                <!-- Pattern Overlay -->
                <path d="M 460 450 Q 500 440 540 450 L 620 750 Q 500 800 380 750 Z" 
                      fill="url(#motif)" style="mix-blend-mode: overlay;"/>
                
                <!-- Gold Border (Gota) -->
                <path d="M 390 740 Q 500 780 610 740 L 620 750 Q 500 800 380 750 Z" 
                      fill="url(#goldGradient)" />
                
                <!-- Central Fold Shadow -->
                <path d="M 500 450 L 520 760 L 480 760 Z" fill="rgba(0,0,0,0.2)" filter="blur(5px)" />
            </g>
            
            <!-- Torso (Angarkha) -->
            <path id="torso" d="M 470 350 L 530 350 L 545 450 L 455 450 Z" fill="#222" stroke="url(#goldGradient)" stroke-width="2"/>
            <path d="M 495 350 L 495 450" stroke="url(#goldGradient)" stroke-width="1" stroke-dasharray="4 2"/>

            <!-- Head & Turban -->
            <circle id="head" cx="500" cy="325" r="35" fill="url(#faceGradient)" />
            
            <!-- Face Details -->
            <g id="face-features" opacity="0.8">
                <path d="M 485 320 Q 490 315 495 320" stroke="#5a3e2b" fill="none" stroke-width="2"/> <!-- Eye L -->
                <path d="M 505 320 Q 510 315 515 320" stroke="#5a3e2b" fill="none" stroke-width="2"/> <!-- Eye R -->
                <circle cx="490" cy="323" r="1.5" fill="#000"/>
                <circle cx="510" cy="323" r="1.5" fill="#000"/>
                <path d="M 500 325 L 498 335 L 502 335 Z" fill="#d4a373"/> <!-- Nose -->
                <path d="M 492 342 Q 500 348 508 342" stroke="#800000" fill="none" stroke-width="1.5"/> <!-- Mouth -->
                <circle cx="500" cy="320" r="1.5" fill="#800000"/> <!-- Bindi -->
            </g>

            <!-- Turban (Pagri) -->
            <path id="turban" d="M 460 300 Q 500 250 540 300 Q 550 320 535 325 L 465 325 Q 450 320 460 300" 
                  fill="#e65100" stroke="#b33c00" stroke-width="1"/>
            <path d="M 465 310 Q 500 290 535 310" stroke="#ffd700" fill="none" stroke-width="3" opacity="0.7"/>

            <!-- Arms (Grouped for rotation) -->
            <g id="arm-left-group">
                <line x1="470" y1="360" x2="440" y2="400" stroke="#d4a373" stroke-width="8" stroke-linecap="round"/>
                <line x1="445" y1="395" x2="435" y2="405" stroke="#ffd700" stroke-width="3"/>
                <circle id="hand-l" cx="440" cy="400" r="6" fill="#d4a373" />
            </g>
            <g id="arm-right-group">
                <line x1="530" y1="360" x2="560" y2="400" stroke="#d4a373" stroke-width="8" stroke-linecap="round"/>
                <line x1="555" y1="395" x2="565" y2="405" stroke="#ffd700" stroke-width="3"/>
                <circle id="hand-r" cx="560" cy="400" r="6" fill="#d4a373" />
            </g>
        </g>
    </svg>

    <!-- Narrative Flow -->
    <div class="scroll-container">
        
        <!-- Act 1: The Intro -->
        <section id="act-1">
            <div class="text-block">
                <h2>Act I</h2>
                <h1>The Illusion</h1>
                <p>Once there was a Kathputli who believed she was dancing on her own.</p>
                <p>She smiled. She bowed.</p>
                <p>She moved beautifully — <span class="highlight">exactly as expected.</span></p>
            </div>
        </section>

        <!-- Act 2: The Dance/Realization -->
        <section id="act-2">
            <div class="text-block">
                <h2>Act II</h2>
                <h1>The Gaze</h1>
                <p>She never looked up.</p>
                <p>Because looking up would mean accepting that every step, every pause, every thunderous applause was guided by <span class="highlight">invisible hands</span>.</p>
            </div>
        </section>

        <!-- Act 3: The Human Reflection -->
        <section id="act-3">
            <div class="text-block">
                <h2>Act III</h2>
                <h1>The Reflection</h1>
                <p>Humans are the same.</p>
                <p>We call it choice. We call it routine. We call it life.</p>
                <p>But are we the dancer, or are we the danced?</p>
            </div>
        </section>

        <!-- Act 4: Finale -->
        <section id="act-4">
            <div class="text-block">
                <h2>Finale</h2>
                <h1>The Strings</h1>
                <p>Somewhere above, the strings still move.</p>
                <p style="text-align: right; margin-top: 2rem; font-style: italic;">— End of Play</p>
            </div>
        </section>

    </div>

    <div class="instruction">Scroll &middot; Move &middot; Listen</div>

    <div class="controls">
        <button class="btn" id="audioBtn">Sound On</button>
    </div>

    <script>
        // Register GSAP Plugins
        gsap.registerPlugin(ScrollTrigger);

        // --- 1. SETUP & CONFIG ---
        const puppet = document.getElementById('kathputli');
        const skirtGroup = document.getElementById('skirt-group');
        
        // String Elements
        const stringHead = document.getElementById('string-head');
        const stringL = document.getElementById('string-l-hand');
        const stringR = document.getElementById('string-r-hand');

        // Initial Puppet State (Center of Screen in SVG coords 0-1000)
        let puppetState = {
            x: 500,
            y: 300,
            rotation: 0,
            skirtSwing: 0
        };

        // Input Tracking (Normalized 0-1000 for SVG consistency)
        let inputTarget = { x: 500, y: 350 };
        
        // --- 2. INPUT HANDLING (MOUSE & TOUCH) ---
        
        function updateInput(clientX, clientY) {
            // Map screen coordinates to SVG viewBox coordinates (0-1000)
            const svgRect = document.getElementById('puppet-container').getBoundingClientRect();
            // Protect against zero-dimension bug on init
            if (svgRect.width === 0) return;

            const scaleX = 1000 / svgRect.width;
            const scaleY = 1000 / svgRect.height;
            
            inputTarget.x = (clientX - svgRect.left) * scaleX;
            inputTarget.y = (clientY - svgRect.top) * scaleY;
        }

        window.addEventListener('mousemove', (e) => updateInput(e.clientX, e.clientY));
        
        // Touch Support
        window.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            updateInput(touch.clientX, touch.clientY);
        }, { passive: true });

        // --- 3. PHYSICS LOOP ---
        gsap.ticker.add(() => {
            // Physics Calculation - "The Lag" (Viscous fluid simulation)
            
            // X-axis: Smooth follow
            let dx = inputTarget.x - puppetState.x;
            puppetState.x += dx * 0.05; 

            // Y-axis: Restrict vertical movement to simulate hanging from strings
            // Clamp Y so it doesn't go too high (off string) or too low
            let targetYSVG = gsap.utils.clamp(100, 800, inputTarget.y);
            let dy = targetYSVG - puppetState.y;
            puppetState.y += dy * 0.05;

            // Rotation based on horizontal velocity (Swing)
            let rotationVelocity = dx * 0.15; 
            puppetState.rotation += (rotationVelocity - puppetState.rotation) * 0.1;

            // Skirt Physics (Secondary Animation - Inertia)
            // Skirt swings opposite to body rotation 
            puppetState.skirtSwing += (rotationVelocity * -1.2 - puppetState.skirtSwing) * 0.06;

            // Apply Transforms
            gsap.set(puppet, {
                x: puppetState.x - 500, // 500 is original drawn CX
                y: puppetState.y - 300, // 300 is original drawn CY top
                rotation: puppetState.rotation,
                transformOrigin: "50% 100px" // Pivot point near head
            });

            gsap.set(skirtGroup, {
                rotation: puppetState.skirtSwing,
                transformOrigin: "50% 0%" // Pivot at waist
            });

            // Update Strings (Parallax effect)
            const stringAnchorX = puppetState.x * 0.5 + 250; // Strings move less than puppet
            
            // Head String
            stringHead.setAttribute("x1", stringAnchorX); 
            stringHead.setAttribute("y1", 0);            
            stringHead.setAttribute("x2", puppetState.x);
            stringHead.setAttribute("y2", puppetState.y + 30); 

            // Left Hand String
            stringL.setAttribute("x1", stringAnchorX - 60);
            stringL.setAttribute("y1", 0);
            stringL.setAttribute("x2", puppetState.x - 60);
            stringL.setAttribute("y2", puppetState.y + 100);

            // Right Hand String
            stringR.setAttribute("x1", stringAnchorX + 60);
            stringR.setAttribute("y1", 0);
            stringR.setAttribute("x2", puppetState.x + 60);
            stringR.setAttribute("y2", puppetState.y + 100);
        });


        // --- 4. SCROLL ANIMATIONS ---
        
        const sections = document.querySelectorAll('section');
        sections.forEach(sec => {
            ScrollTrigger.create({
                trigger: sec,
                start: "top 60%",
                onEnter: () => sec.classList.add('visible'),
                onLeaveBack: () => sec.classList.remove('visible')
            });
        });

        // ACT 2: DANCE 
        ScrollTrigger.create({
            trigger: "#act-2",
            start: "top center",
            end: "bottom center",
            onToggle: (self) => {
                if(self.isActive) {
                    gsap.to(puppet, {
                        scale: 1.05,
                        yoyo: true,
                        repeat: -1,
                        duration: 0.6,
                        ease: "sine.inOut"
                    });
                } else {
                    gsap.to(puppet, { scale: 1 });
                }
            }
        });

        // ACT 3: TENSION
        ScrollTrigger.create({
            trigger: "#act-3",
            start: "top center",
            end: "bottom center",
            onToggle: (self) => {
                if(self.isActive) {
                    gsap.to(".string", { stroke: "#ff4d4d", strokeWidth: 2, duration: 0.5 });
                } else {
                    gsap.to(".string", { stroke: "rgba(255,255,255,0.4)", strokeWidth: 1, duration: 0.5 });
                }
            }
        });

        // ACT 4: BOW
        ScrollTrigger.create({
            trigger: "#act-4",
            start: "top center",
            onEnter: () => {
                // The final bow animation - puppet goes limp
                gsap.to(puppet, {
                    rotation: 80,
                    y: "+=150",
                    opacity: 0.5,
                    duration: 2.5,
                    ease: "power2.out"
                });
                gsap.to(".string", { opacity: 0, duration: 2 });
            },
            onLeaveBack: () => {
                gsap.to(puppet, { rotation: 0, opacity: 1, duration: 1 });
                gsap.to(".string", { opacity: 0.6, duration: 1 });
            }
        });


        // --- 5. AUDIO SYSTEM (Procedural/Generative) ---
        const audioBtn = document.getElementById('audioBtn');
        let audioCtx;
        let isPlaying = false;
        let masterGain;
        let melodyInterval;

        // Pentatonic Scale (Bhupali / Major Pentatonic-ish)
        // C4, D4, E4, G4, A4, C5 (Hz)
        const scale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25];

        audioBtn.addEventListener('click', () => {
            if (!isPlaying) {
                initAudio();
                // Gentle fade in
                masterGain.gain.cancelScheduledValues(audioCtx.currentTime);
                masterGain.gain.setValueAtTime(0, audioCtx.currentTime);
                masterGain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 2);
                
                startMelody();

                audioBtn.textContent = "Silence";
                audioBtn.style.background = "#FFD700";
                audioBtn.style.color = "#000";
                isPlaying = true;
            } else {
                // Gentle fade out
                masterGain.gain.cancelScheduledValues(audioCtx.currentTime);
                masterGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);
                
                clearInterval(melodyInterval);

                setTimeout(() => {
                    if (audioCtx) audioCtx.suspend();
                    audioBtn.textContent = "Sound On";
                    audioBtn.style.background = "rgba(0,0,0,0.4)";
                    audioBtn.style.color = "#FFD700";
                }, 2000);
                isPlaying = false;
            }
        });

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                masterGain.gain.value = 0;

                // Drone: Warm Background Pad
                createDrone(130.81, 0.08); // C3
                createDrone(196.00, 0.05); // G3
            } else {
                audioCtx.resume();
            }
        }

        function createDrone(freq, vol) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = "sine"; 
            osc.frequency.value = freq;
            gain.gain.value = vol;
            osc.connect(gain);
            gain.connect(masterGain);
            osc.start();
        }

        function playSoftNote() {
            if(audioCtx.state === 'suspended') return;

            const osc = audioCtx.createOscillator();
            const noteGain = audioCtx.createGain();
            
            const noteIndex = Math.floor(Math.random() * scale.length);
            const freq = scale[noteIndex];

            osc.type = "triangle"; 
            osc.frequency.value = freq;

            // Envelope: Wind chime effect
            const now = audioCtx.currentTime;
            noteGain.gain.setValueAtTime(0, now);
            noteGain.gain.linearRampToValueAtTime(0.04, now + 0.1); 
            noteGain.gain.exponentialRampToValueAtTime(0.001, now + 4.0); 

            osc.connect(noteGain);
            noteGain.connect(masterGain);

            osc.start();
            osc.stop(now + 4.5);
        }

        function startMelody() {
            playSoftNote(); 
            melodyInterval = setInterval(() => {
                 // 60% chance to play a note (creates space/silence)
                 if(Math.random() > 0.4) playSoftNote(); 
            }, 1800);
        }
    </script>
</body>
</html>
